unit CadastrarServico;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Imaging.pngimage,
  Vcl.ExtCtrls,pg_home,conexao;

type
  TForm7 = class(TForm)
    GroupBox1: TGroupBox;
    Image1: TImage;
    LabelMensagem: TLabel;
    ButtonVoltar: TButton;
    Labeltitulo: TLabel;
    EditTitulo: TEdit;
    LabelDescricao: TLabel;
    EditDescricao: TEdit;
    Labelpreco: TLabel;
    Editpreço: TEdit;
    ButtonSalvar: TButton;
    ComboCategoria: TComboBox;
    Label1: TLabel;
    procedure ButtonVoltarClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure ButtonSalvarClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form7: TForm7;

implementation
uses
Paguina_servicos;
{$R *.dfm}

procedure TForm7.ButtonSalvarClick(Sender: TObject);
var
  NovoID, CategoriaID: Integer;
begin
  if ComboCategoria.ItemIndex = -1 then
  begin
    ShowMessage('Selecione uma categoria.');
    Exit;
  end;

  CategoriaID := Integer(ComboCategoria.Items.Objects[ComboCategoria.ItemIndex]);

  with DataModule2.FDQuery1 do
  begin
    Close;
    SQL.Text := 'SELECT COALESCE(MAX(ID_SERVICO), 0) + 1 AS NovoID FROM SERVICO';
    Open;
    NovoID := FieldByName('NovoID').AsInteger;
    Close;
  end;

  with DataModule2.FDQuery1 do
  begin
    Close;
    SQL.Text :=
      'INSERT INTO servico (id_servico, id_categoria, titulo, descricao, preco) ' +
      'VALUES (:id, :cat, :tit, :desc, :preco)';
    ParamByName('id').AsInteger := NovoID;
    ParamByName('cat').AsInteger := CategoriaID;
    ParamByName('tit').AsString := EditTitulo.Text;
    ParamByName('desc').AsString := EditDescricao.Text;
    ParamByName('preco').AsFloat := StrToFloatDef(EditPreço.Text, 0);
    ExecSQL;
  end;

  ShowMessage('Serviço cadastrado com sucesso!');
  pag_home.MostrarFormularioEmbed(Form2);
  Form2.CarregarServicos; // atualiza a lista de serviços
end;

procedure TForm7.ButtonVoltarClick(Sender: TObject);
begin
  pag_home.MostrarFormularioEmbed(Form2);
end;

procedure TForm7.FormShow(Sender: TObject);
begin
  if not DataModule2.FDConnection1.Connected then
    DataModule2.FDConnection1.Connected := True;

  with DataModule2.FDQuery1 do
  begin
    Close;
    SQL.Text := 'SELECT id_categoria, nome FROM categoria ORDER BY nome';
    Open;

    ComboCategoria.Items.Clear;
    while not Eof do
    begin
      // Adiciona o nome da categoria, mas guarda o ID no objeto
      ComboCategoria.Items.AddObject(
        FieldByName('nome').AsString,
        TObject(FieldByName('id_categoria').AsInteger)
      );
      Next;
    end;
    Close;
  end;
end;

end.
